<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>注册</title>

    <!-- bootcss -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <!-- bootcss End -->

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <!-- fontawesome End -->

    <!-- jquery -->
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
    <!-- jquery End -->

    <!-- bootcss-js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootcss-js End -->
  </head>
  <body>
    <!-- 注册表单 -->
    <div class="container" style="margin-top: 50px">
      <form
        id="register_form"
        class="form-horizontal"
        role="form"
        method="POST"
        action="/user/signup"
      >
        <div class="row">
          <div class="col-md-3"></div>
          <div class="col-md-6">
            <h2>Register New User</h2>
            <hr />
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-label-responsive">
            <label for="name">Name</label>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <input
                type="text"
                name="username"
                class="form-control"
                id="username"
                placeholder="Username"
                value=""
                required=""
                autocomplete="off"
              />
              <div id="username_feedback" class="invalid-feedback"></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-label-responsive">
            <label for="password">Password</label>
          </div>
          <div class="col-md-4">
            <div class="form-group has-danger">
              <input
                type="password"
                name="password"
                class="form-control"
                id="password"
                placeholder="Password"
                required=""
                autocomplete="off"
              />
              <div id="password_feedback" class="invalid-feedback"></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 field-label-responsive">
            <label for="password">Confirm Password</label>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <input
                type="password"
                name="password_confirmation"
                class="form-control"
                id="password_confirmation"
                placeholder="Password"
                required=""
                autocomplete="off"
              />
              <div
                id="password_confirmation_feedback"
                class="invalid-feedback"
              ></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4"></div>
          <div class="col-md-4">
            <button type="button" id="submiButton" class="btn btn-success">
              <em class="fa fa-user-plus"></em> Register
            </button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4"></div>
          <div class="col-md-4">
            <div role="signup">
              <a href="/user/login">Already Registered?</a>
            </div>
          </div>
        </div>
      </form>
    </div>
    <!-- 注册表单 End -->

    <!-- 注册JS逻辑 -->
    <script>
      let errorMessage = {
        username_empty: "请输入用户名",
        usernamestrengthfail: "用户名格式错误, 需要3到16个字符, 允许大小写数字",
        password_empty: "密码为空, 请输入密码",
        pwstrengthfail:
          "您设定的密码强度不足，请使用更复杂的密码。长度8位以上,必须包含大小写字母数字, 符号允许 <storage>$@!%*?&.[]{}/</storage>",
        passwordconfirm: "You did not confirm your password",
        pwdoesnotmatch: "The passwords entered do not match",
      };

      let usernamePattern = /^[a-zA-Z0-9_-]{3,16}$/;
      let passwordPattern =
        /^(?![\d]+$)(?![a-zA-Z]+$)(?![!#$%^&*]+$)[\da-zA-Z!#$%^&*@.\[\]{}\/]{8,}$/;

      $("#reload-verifyimage").click(function () {
        reloadVerify();
      });

      function setFormValid(id) {
        $(id).removeClass("is-invalid").addClass("is-valid");
        $(id).closest("div").find("div.invalid-feedback").html("");
      }
      function setFormError(id, msg) {
        $(id).removeClass("is-valid").addClass("is-invalid");
        $(id).focus();
        $(id).closest("div").find("div.invalid-feedback").html(msg);
      }

      $(document).ready(function () {
        let username = $("#username");
        let password = $("#password");
        let pwconfirm = $("#password_confirmation");

        $(username).on("change", function () {
          if (!username.val()) {
            setFormError(username, errorMessage["username_empty"]);
          } else if (!usernamePattern.test(username.val())) {
            setFormError(username, errorMessage["usernamestrengthfail"]);
          } else {
            setFormValid(username);
          }
        });

        $(password).change(function () {
          if (!password.val()) {
            setFormError(username, errorMessage["password_empty"]);
          } else if (!passwordPattern.test(password.val())) {
            setFormError(password, errorMessage["pwstrengthfail"]);
          } else {
            setFormValid(password);
          }
        });

        $(pwconfirm).change(function () {
          if (!pwconfirm.val()) {
            setFormError(pwconfirm, errorMessage["passwordconfirm"]);
          } else if (password.val() !== pwconfirm.val()) {
            setFormError(pwconfirm, errorMessage["pwdoesnotmatch"]);
          } else if (!passwordPattern.test(pwconfirm.val())) {
            setFormError(pwconfirm, errorMessage["pwstrengthfail"]);
          } else {
            setFormValid(pwconfirm);
          }
        });

        $("#submiButton").click(function (event) {
          let isValid = false;

          username.removeClass("is-invalid");
          password.removeClass("is-invalid");
          pwconfirm.removeClass("is-invalid");

          if (!username.val()) {
            setFormError(username, errorMessage["username_empty"]);
          } else if (!usernamePattern.test(username.val())) {
            setFormError(username, errorMessage["usernamestrengthfail"]);
          } else if (!password.val()) {
            setFormError(password, errorMessage["password_empty"]);
          } else if (!pwconfirm.val()) {
            setFormError(pwconfirm, errorMessage["passwordconfirm"]);
          } else if (password.val() !== pwconfirm.val()) {
            setFormError(pwconfirm, errorMessage["pwdoesnotmatch"]);
          } else if (!passwordPattern.test(password.val())) {
            setFormError(pwconfirm, errorMessage["pwstrengthfail"]);
          } else {
            isValid = true;
            $("form#register_form")[0].submit();
          }
          if (isValid !== true) {
            event.preventDefault();
          }
        });
      });
    </script>
    <!-- 注册JS逻辑 End -->
  </body>
</html>
