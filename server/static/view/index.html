<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="https://www.biuaxia.cn/images/Icarus-logo.svg" />
    <title>Document</title>

    <!-- bootcss -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <!-- bootcss End -->

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <!-- fontawesome End -->

    <!-- bootstrap-fileinput -->
    <link
      rel="stylesheet"
      href="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css"
    />
    <!-- bootstrap-fileinput End -->

    <!-- jquery -->
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
    <!-- jquery End -->

    <!-- bootcss-js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootcss-js End -->

    <!-- bootstrap-fileinput-js -->
    <script
      src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/sortable.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/purify.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"
      type="text/javascript"
    ></script>
    <script src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/fas/theme.min.js"></script>
    <script
      src="https://cdnjs.rsb.net/ajax/libs/bootstrap-fileinput/4.5.1/js/locales/zh.js"
      type="text/javascript"
    ></script>
    <!-- bootstrap-fileinput-js End -->
  </head>
  <body>
    <!-- 文件上传表单 -->
    <div>
      <div class="page-header">
        <h1>Image Upload</h1>
        5 MB max per file. 10 files max per request.
      </div>
      <form enctype="multipart/form-data">
        <div class="form-group" style="max-height: 2000px">
          <input
            id="smfile"
            type="file"
            multiple
            class="file"
            data-overwrite-initial="false"
            data-min-file-count="1"
            name="smfile"
            accept="image/*"
          />
        </div>
      </form>
    </div>
    <!-- 文件上传表单 End -->

    <!-- 文件上传JS逻辑 -->
    <script type="text/javascript">
      let $smfile = $("#smfile");
      $smfile.fileinput({
        theme: "fas",
        uploadUrl: "/file/upload",
        uploadExtraData: function (previewId, index) {
          var dataArray = $("#upload_option").serializeArray(),
            len = dataArray.length,
            dataObj = {};

          for (let i = 0; i < len; i++) {
            dataObj[dataArray[i].name] = dataArray[i].value;
          }
          return dataObj;
        },
        allowedFileExtensions: ["jpeg", "jpg", "png", "gif", "bmp", "webp"],
        overwriteInitial: false,
        previewFileType: "image",
        maxFileSize: "5120",
        maxFileCount: "10",
        autoOrientImage: true,
        fileActionSettings: {
          showRemove: true,
          showUpload: false,
          showZoom: true,
          showDrag: true,
        },
        browseClass: "btn btn-success",
        browseLabel: "Select Image(s)",
        browseIcon: '<i class="fas fa-images"></i> ',
        removeClass: "btn btn-danger",
        removeLabel: "Clear",
        uploadClass: "btn btn-info",
        uploadLabel: "Upload",
        dropZoneTitle:
          "Drag & drop files here ...<br>or<br>Copy & paste screenshots here ...",
      });

      function hasHtmlTags(string) {
        var pattern = /<(.*)>/;
        console.log(pattern.test(string));
        return pattern.test(string);
      }

      $smfile.on("fileselect", function (event, numFiles, label) {
        var files = $("#smfile").fileinput("getFileStack");
        $.each(files, function (index, blob) {
          if (hasHtmlTags(blob.name)) {
            let filename = DOMPurify.sanitize(blob.name);
            filename = filename.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const myNewFile = new File([blob], filename, { type: blob.type });
            $smfile.fileinput("updateStack", index, myNewFile);
          }
        });
      });

      $smfile.on("fileuploaded", function (event, data, previewId, index) {
        var form = data.form,
          files = data.files,
          extra = data.extra,
          response = data.response,
          reader = data.reader;
        if (response.code === "success") {
          if ($("#showurl").html()) {
            $("#showurl").show();
          }
          $("#imagedetail").append(formatHtml(response.data));
          $("#urlcode").append(response.data.url + "\n");
          $("#linkcode").append(response.data.page + "\n");
          $("#htmlcode").append(
            '&lt;a href="' +
              response.data.page +
              '" target="_blank"&gt;&lt;img src="' +
              (response.data.thumb == null
                ? response.data.url
                : response.data.thumb.url) +
              '" /&gt;&lt;/a&gt;' +
              "\n"
          );
          $("#bbcode").append(
            "[url=" +
              response.data.page +
              "][img]" +
              (response.data.thumb == null
                ? response.data.url
                : response.data.thumb.url) +
              "[/img][/url]" +
              "\n"
          );
          $("#markdown").append(
            "![" +
              files[index].name +
              "](" +
              (response.data.thumb == null
                ? response.data.url
                : response.data.thumb.url) +
              ")" +
              "\n"
          );
          $("#removelink").append(response.data.delete + "\n");
        }
      });
      $smfile.on("filecleared", function (event) {
        if ($("#showurl").is(":visible")) {
          layer.confirm(
            "是否要清空历史上传",
            {
              btn: ["Yes", "No"], //按钮
            },
            function (index) {
              $("#imagedetail").html("");
              $("#urlcode").html("");
              $("#linkcode").html("");
              $("#htmlcode").html("");
              $("#bbcode").html("");
              $("#markdown").html("");
              $("#removelink").html("");
              $("#showurl").hide();
              layer.close(index);
            },
            function () {}
          );
        }
      });

      let div_caption = $(".kv-fileinput-caption");
      div_caption.attr("onclick", "clickFile()");
      function clickFile() {
        $smfile.click();
      }

      $smfile.on("filebatchuploadcomplete", function (event, files, extra) {
        $("img.lazy").lazyload();
      });
    </script>
    <!-- 文件上传JS逻辑 End -->
  </body>
</html>
