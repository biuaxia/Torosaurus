<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>登录</title>

    <!-- bootcss -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <!-- bootcss End -->

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <!-- fontawesome End -->

    <!-- jquery -->
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.rsb.net/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
    <!-- jquery End -->

    <!-- bootcss-js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootcss-js End -->
  </head>
  <body>
    <!-- 登录表单 -->
    <div class="container" style="margin-top: 50px">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <article role="login">
            <h3 class="text-center"><em class="fas fa-lock"></em> Login</h3>
            <form
              id="login_form"
              class="signup"
              action="/user/signin"
              method="post"
            >
              <div class="form-group">
                <input
                  type="text"
                  id="username"
                  name="username"
                  value=""
                  class="form-control"
                  placeholder="User Name"
                  required=""
                />
              </div>

              <div class="form-group">
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="form-control"
                  placeholder="Password"
                  required=""
                />
              </div>

              <div class="form-group">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" name="remember" value="1" />
                    Remember Me
                  </label>
                </div>
              </div>

              <div class="form-group">
                <input
                  type="button"
                  id="submiButton"
                  class="btn btn-success btn-block"
                  value="Login"
                />
              </div>
            </form>

            <footer role="signup">
              <a href="/user/pwreset">Forgot Password?</a>
              <span style="margin: 0 5px">|</span
              ><a href="/user/signup">Register</a>
            </footer>
          </article>
        </div>
      </div>
    </div>
    <!-- 登录表单 End -->

    <!-- 登录JS逻辑 -->
    <script>
      function setFormValid(id) {
        $(id).removeClass("is-invalid").addClass("is-valid");
        $(id).closest("div").find("div.invalid-feedback").html("");
      }

      function setFormError(id, msg) {
        $(id).removeClass("is-valid").addClass("is-invalid");
        $(id).focus();
        $(id).closest("div").find("div.invalid-feedback").html(msg);
      }

      let errorMessage = {
        username_empty: "请输入用户名",
        usernamestrengthfail: "用户名格式错误, 需要3到16个字符, 允许大小写数字",
        password_empty: "密码为空, 请输入密码",
        pwstrengthfail:
          "您设定的密码强度不足，请使用更复杂的密码。长度8位以上,必须包含大小写字母数字, 符号允许 <storage>$@!%*?&.[]{}/</storage>",
        passwordconfirm: "You did not confirm your password",
        pwdoesnotmatch: "The passwords entered do not match",
      };

      $(document).ready(function () {
        let username = $("#username");
        let password = $("#password");

        username.keyup(function (e) {
          if (e.keyCode == 13) {
            if (username.val() != "") {
              password.focus();
            }
          }
        });

        password.keyup(function (e) {
          if (e.keyCode == 13) {
            if (username.val() == "") {
              username.focus();
            } else if (password.val() == "") {
              password.focus();
            } else {
              $("#submiButton").click();
            }
          }
        });

        $("#submiButton").click(function (event) {
          let isValid = false;

          username.removeClass("is-invalid");
          password.removeClass("is-invalid");

          if (!username.val()) {
            setFormError(username, errorMessage["username_empty"]);
          } else if (!password.val()) {
            setFormError(password, errorMessage["password_empty"]);
          } else {
            isValid = true;
            // $("form#login_form")[0].submit();
            $.ajax({
              url: "/user/signin",
              type: "POST",
              data: {
                username: username.val(),
                password: password.val(),
              },
              error: function (err) {
                setFormError(username, err["responseText"]);
                setFormError(password, err["responseText"]);
              },
              success: function (res) {
                location.href = res;
              },
            });
          }
          if (isValid !== true) {
            event.preventDefault();
          }
        });
      });
    </script>
    <!-- 登录JS逻辑 End -->
  </body>
</html>
